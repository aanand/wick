#!/usr/bin/env ruby

require 'slop'

require 'socket'

require 'irc_client'
require 'irc_client/client'
require 'irc_client/ui/raw'
require 'irc_client/ui/nice'
require 'irc_client/manager'

opts = Slop.parse(help: true) do
  on 'host=', 'Hostname of server to connect to', default: 'localhost'
  on 'port=', 'Port to connect to',               default: '6667'
  on 'nick=', 'Nick (and username) to use',       default: 'frippery'
  on 'log=',  'Filename to log to (default: irc.log, stderr if blank)', default: 'irc.log'
end

if opts[:log] != ''
  $stderr.reopen File.open(opts[:log], 'a')
  $stderr.sync = true
end

client  = IRCClient::Client.new(opts[:nick])
ui      = IRCClient::UI::Nice.new(opts[:nick])
manager = IRCClient::Manager.new(client, ui)

socket = TCPSocket.new(opts[:host], opts[:port])

Wick.listen!([socket, $stdin], [socket, $stdout]) do |read_streams|
  network_in, user_in = read_streams
  manager.transform(network_in, user_in)
end

